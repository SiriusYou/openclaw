# ============================================================================
# OpenClaw Marketing Agent System â€” Docker Compose (Hybrid Mode)
# ============================================================================
#
# Hybrid mode: native macOS gateway + Docker sandboxes
#
# Usage:
#   # Build sandbox images first:
#   docker compose -f docker-compose.marketing.yml build
#
#   # Start sandbox containers:
#   docker compose -f docker-compose.marketing.yml up -d
#
#   # Stop:
#   docker compose -f docker-compose.marketing.yml down
#
#   # Full Docker mode (gateway + CLI in Docker too):
#   docker compose -f docker-compose.marketing.yml --profile full up -d
#
# ============================================================================

services:
  # --- Tool Execution Sandbox ---
  # Isolates agent tool calls (file writes, shell commands) in a secure container
  sandbox:
    build:
      context: ..
      dockerfile: Dockerfile.sandbox
    image: openclaw-sandbox:bookworm-slim
    restart: unless-stopped
    read_only: true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=128m

  # --- Browser Sandbox (competitive intel / SEO screenshots) ---
  # Provides a headless browser for the Analyst agent
  sandbox-browser:
    build:
      context: ..
      dockerfile: Dockerfile.sandbox-browser
    image: openclaw-sandbox-browser:bookworm-slim
    restart: unless-stopped
    read_only: true
    cap_drop:
      - ALL
    environment:
      OPENCLAW_BROWSER_CDP_PORT: 9222
      OPENCLAW_BROWSER_HEADLESS: 0
      OPENCLAW_BROWSER_ENABLE_NOVNC: 1
    ports:
      - "127.0.0.1:9222:9222"    # CDP (agent connects here)
      - "127.0.0.1:6080:6080"    # noVNC (human observation)
    tmpfs:
      - /tmp:noexec,nosuid,size=512m

  # --- Gateway (full Docker mode only) ---
  openclaw-gateway:
    build:
      context: ..
      dockerfile: Dockerfile
    image: openclaw:local
    restart: unless-stopped
    init: true
    environment:
      HOME: /home/node
      NODE_ENV: production
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw}:/home/node/.openclaw
    ports:
      - "127.0.0.1:${OPENCLAW_GATEWAY_PORT:-18789}:18789"
    command: ["node", "openclaw.mjs", "gateway", "--bind", "loopback", "--port", "18789"]
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:18789/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    profiles: ["full"]

  # --- Interactive CLI (full Docker mode only) ---
  openclaw-cli:
    image: openclaw:local
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      BROWSER: echo
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw}:/home/node/.openclaw
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "openclaw.mjs"]
    profiles: ["full"]
