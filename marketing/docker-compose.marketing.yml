# ============================================================================
# OpenClaw Marketing Agent System â€” Docker Compose
# ============================================================================
#
# Usage:
#   docker compose -f docker-compose.marketing.yml up -d          # Start core
#   docker compose -f docker-compose.marketing.yml --profile cli run --rm openclaw-cli
#   docker compose -f docker-compose.marketing.yml --profile ingest up -d skill-seekers
#   docker compose -f docker-compose.marketing.yml down            # Stop all
#
# Requires .env file (generated by setup.sh)
# ============================================================================

services:
  # --- Core Gateway ---
  openclaw-gateway:
    image: openclaw:local
    restart: unless-stopped
    init: true
    environment:
      HOME: /home/node
      NODE_ENV: production
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
    ports:
      - "127.0.0.1:${OPENCLAW_GATEWAY_PORT:-18789}:18789"
    command:
      - node
      - openclaw.mjs
      - gateway
      - --bind
      - ${OPENCLAW_GATEWAY_BIND:-loopback}
      - --port
      - "18789"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:18789/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # --- Interactive CLI ---
  openclaw-cli:
    image: openclaw:local
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      BROWSER: echo
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "openclaw.mjs"]
    profiles: ["cli"]

  # --- Tool Execution Sandbox ---
  sandbox:
    image: openclaw-sandbox:bookworm-slim
    restart: unless-stopped
    read_only: true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=128m

  # --- Browser Sandbox (competitive intel / SEO screenshots) ---
  sandbox-browser:
    image: openclaw-sandbox-browser:bookworm-slim
    restart: unless-stopped
    read_only: true
    cap_drop:
      - ALL
    environment:
      OPENCLAW_BROWSER_CDP_PORT: 9222
      OPENCLAW_BROWSER_HEADLESS: 0
      OPENCLAW_BROWSER_ENABLE_NOVNC: 1
    ports:
      - "127.0.0.1:9222:9222"    # CDP (agent connects here)
      - "127.0.0.1:6080:6080"    # noVNC (human observation)
    tmpfs:
      - /tmp:noexec,nosuid,size=512m

  # --- Knowledge Ingestion (on-demand) ---
  skill-seekers:
    image: python:3.12-slim
    volumes:
      - ${OPENCLAW_WORKSPACE_DIR}:/workspaces
    working_dir: /opt/skill_seekers
    command: ["python", "-m", "skill_seekers.mcp.server_fastmcp"]
    profiles: ["ingest"]
